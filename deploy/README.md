# GCP VM Deployment (Docker Compose)

This guide deploys the API, Postgres, MinIO, and Qdrant on a single Google Compute Engine VM using Docker Compose. It includes steps for a minimal setup first, and an optional HTTPS reverse proxy.

## 1) Prepare the VM

- Ubuntu 22.04+ or Debian 12 recommended.
- Open firewall in GCP for the ports you will use:
  - Minimal: TCP 80 (API), TCP 9000 (MinIO S3)
  - Optional: TCP 443 (TLS via proxy), TCP 9001 (MinIO console, avoid exposing publicly)

SSH into the VM and install Docker + Compose:

```
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") \
  $(. /etc/os-release; echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo usermod -aG docker $USER
newgrp docker
```

## 2) Configure environment

Create a `.env` in the repo root on the VM (or copy from your laptop but DO NOT commit secrets):

```
# App
APP_ENV=prod
APP_VERSION=0.1.0
REGION=gcp
TENANT_ID=00000000-0000-0000-0000-000000000001

# Postgres
POSTGRES_DB=ragdb
POSTGRES_USER=rag
POSTGRES_PASSWORD=change-me-strong

# MinIO
MINIO_ROOT_USER=ragminio
MINIO_ROOT_PASSWORD=change-me-strong
S3_BUCKET=rag-blobs
S3_CANONICAL_BUCKET=rag-canonical

# Vector DB
QDRANT_API_KEY=

# Providers
OPENAI_API_KEY=

# CORS (optional, comma-separated list)
CORS_ALLOW_ORIGINS=https://your-frontend.example.com,https://example.com

# Public endpoint for presigned URLs generated by API for the browser
# If using raw VM IPs and exposing 9000 directly:
# S3_PUBLIC_ENDPOINT=http://YOUR_VM_IP:9000
# If using a reverse proxy with a subdomain:
# S3_PUBLIC_ENDPOINT=https://s3.your-domain.com
```

Security tips:
- Use strong passwords; don’t expose MinIO console (9001) or Qdrant to the public Internet.
- If exposing MinIO 9000, rotate credentials and limit access in your GCP firewall.

## 3) Launch with Docker Compose

From the repo root on the VM:

```
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```

Verify:

```
curl -sS http://localhost/healthz | jq .
```

If you opened port 80 publicly, replace `localhost` with your VM IP or domain in a browser: `http://YOUR_VM_IP/` (UI) and `http://YOUR_VM_IP/healthz` (API).

For document links to open from the browser, ensure `S3_PUBLIC_ENDPOINT` matches how the browser reaches MinIO (VM IP:9000 or a subdomain).

## 4) Optional: HTTPS reverse proxy (Caddy)

If you have DNS for `api.your-domain.com` and `s3.your-domain.com`, you can terminate TLS and avoid exposing raw ports.

Example `deploy/caddy/Caddyfile` (already provided):

```
api.your-domain.com {
  reverse_proxy 127.0.0.1:8000
}

s3.your-domain.com {
  reverse_proxy 127.0.0.1:9000
}
```

Install and run Caddy:

```
sudo apt-get install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo tee /etc/apt/trusted.gpg.d/caddy-stable.asc
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt-get update && sudo apt-get install -y caddy
sudo mkdir -p /etc/caddy
sudo cp deploy/caddy/Caddyfile /etc/caddy/Caddyfile
sudo systemctl enable --now caddy
```

Set in `.env`:

```
S3_PUBLIC_ENDPOINT=https://s3.your-domain.com
CORS_ALLOW_ORIGINS=https://api.your-domain.com,https://your-frontend.example.com
```

## 5) Run on boot with systemd (Compose)

Create a unit to auto-start the stack on boot:

```
sudo cp deploy/systemd/rag.service /etc/systemd/system/rag.service
sudo systemctl daemon-reload
sudo systemctl enable --now rag
```

Check status/logs:

```
systemctl status rag
journalctl -u rag -f
docker compose ps
```

## 6) Smoke tests

- API: `curl http://YOUR_HOST/healthz`
- UI: open `http://YOUR_HOST/` → status shows Connected
- Upload a file: use the UI Upload button; confirm it appears in Documents
- Ask a question; confirm citations open (presigned URLs hit your MinIO endpoint)

## 7) Hardening (recommended)

- Restrict GCP firewall to 80/443 only; avoid exposing 9000/9001.
- Use the Caddy reverse proxy with separate subdomains and TLS.
- Rotate credentials and keep `.env` out of version control.
- Consider managed services (Cloud SQL, GCS, Qdrant Cloud) for scalability.

